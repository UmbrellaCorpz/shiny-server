---
title: "SIF Aldabra tidal predictions"
resource_files:
- data/processed/tide_pred/loc_1/2016.rds
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    navbar:
      - { title: "charts", href: "/aldabratides_chart", align: left}
      - { title: "calendar", href: "/aldabratides_calendar" align: left }
      - { title: "download", align: left }
    orientation: columns
    css: tides_style.css
    theme: yeti
    vertical_layout: fill
---


```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(magrittr)
library(plotly)
library(ggplot2)
library(RSQLite)
library(DT)

tide_models_params <- readRDS("data/processed/tide_models_params.rds")
source("dashboard_functions.R")
tide <- dplyr::src_sqlite('data/processed/tide_predictions.sqlite3')

# local coordinates of Aldabra
coords <- matrix(c(46.3, -9.4), nrow = 1)
little_extra <- 10*60 # padding around each date to calculate high and low tides



# filter water height for a time interval
read_height <- function(dr, loc){
	d_start <- as.integer(dr[1])
	d_end <- as.integer(dr[2])
	o <- dplyr::tbl(tide, 'tide_prediction') %>%
    dplyr::filter(date >= d_start,
                  date <= d_end, 
    							loc_id == loc) %>%
		dplyr::collect()
	
	o %>%
    dplyr::mutate(time = as.POSIXct(date, tz = "Indian/Mahe", origin = "1970-01-01"))
}


read_high_low <- function(dr, loc) {
	
	d_start <- as.integer(dr[1])
	d_end <- as.integer(dr[2])
	o <- dplyr::tbl(tide, 'tide_high_low') %>%
    dplyr::filter(date >= d_start,
                  date <= d_end, 
    							loc_id == loc) %>%
		dplyr::collect()
	
	o %>%
    dplyr::mutate(time = as.POSIXct(date, tz = "Indian/Mahe", origin = "1970-01-01"))
}
```


download
=======================================================================

Options {.sidebar}
-----------------------------------------------------------------------


```{r inputs_download}
selectInput("Loc", label = h3("Location"), 
            choices = list("Picard, Research Station" = 1), 
            selected = 1)


dateRangeInput("DateRange_download", label = h4("Time Range"), start = Sys.Date(), end = Sys.Date(), min = NULL, max = NULL, format = "d MM", startview = "month", weekstart = 0, language = "en", separator = " to ")


```

#### 

##### Export tidal data into Excel:

```{r}

downloadButton('downloadData', label = "Download Data")

downloadHandler(filename = function() {
  paste0("tide-data_", input$DateRange_download[1], "_", input$DateRange_download[2], ".xlsx")
}, content = function (file){
	 dr <- input$DateRange_download
  l <- as.integer(input$Loc)

  dr <- sort(dr)
  dr[2] <- dr[2] + 1
  dr[1] <- dr[1]
  dr <- as.POSIXct(trunc(as.POSIXct(as.POSIXlt(as.POSIXct(dr), tz = "Indian/Mahe")), "days"))
  dr[1] <- dr[1] - little_extra
  dr[2] <- dr[2] + little_extra
  
  xlsx::write.xlsx(read_height(dr, l), file, sheetName = 'water_level')
  xlsx::write.xlsx(format_tide_table(read_high_low(dr, l)), file, sheetName = 'high_low', append = T)

})



```

Column 
-----------------------------------------------------------------------

<div class="excel">
![](ssis-export-excel-file-task.png)
</div>

